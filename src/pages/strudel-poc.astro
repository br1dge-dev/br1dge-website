---
// Strudel Proof of Concept - Test Page
// Tests: 1) Basic playback, 2) Dynamic parameters, 3) Layer control
---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strudel PoC</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, sans-serif;
      background: #111;
      color: #fff;
      padding: 2rem;
      min-height: 100vh;
    }
    h1 { margin-bottom: 1rem; color: #888; }
    h2 { margin: 1.5rem 0 0.5rem; color: #666; font-size: 0.9rem; text-transform: uppercase; }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    button {
      background: #333;
      color: #fff;
      border: 1px solid #555;
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      font-size: 1rem;
      border-radius: 4px;
      transition: all 0.2s;
    }
    button:hover { background: #444; }
    button:active { background: #555; }
    button.active { background: #228B22; border-color: #228B22; }
    
    .slider-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .slider-group label {
      font-size: 0.8rem;
      color: #888;
    }
    input[type="range"] {
      width: 200px;
      cursor: pointer;
    }
    
    #log {
      background: #000;
      border: 1px solid #333;
      padding: 1rem;
      font-family: monospace;
      font-size: 0.85rem;
      height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      color: #0f0;
    }
    
    .status {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      margin-left: 1rem;
    }
    .status.ok { background: #228B22; }
    .status.error { background: #8B0000; }
    .status.pending { background: #444; }
  </style>
</head>
<body>
  <h1>Strudel PoC <span id="status" class="status pending">Not Started</span></h1>
  
  <h2>Test 1: Basic Playback</h2>
  <div class="controls">
    <button id="init">Initialize Strudel</button>
    <button id="play">Play Pattern</button>
    <button id="stop">Stop (hush)</button>
  </div>
  
  <h2>Test 2: Dynamic Parameters</h2>
  <div class="controls">
    <div class="slider-group">
      <label>Intensity (LPF + Gain): <span id="intensityValue">0.5</span></label>
      <input type="range" id="intensity" min="0" max="100" value="50" />
    </div>
  </div>
  
  <h2>Test 3: Layer Control</h2>
  <div class="controls">
    <button id="toggleLead">Lead: ON</button>
    <button id="toggleBass">Bass: OFF</button>
    <button id="toggleHihat">HiHat: OFF</button>
    <button id="toggleKick">Kick: OFF</button>
  </div>
  
  <h2>Test 4: One-Shot Trigger</h2>
  <div class="controls">
    <button id="triggerSfx">Trigger SFX Note</button>
  </div>
  
  <h2>Log</h2>
  <div id="log">Waiting for initialization...</div>

  <script type="module">
    // ================================================
    // Strudel PoC - Testing Integration
    // ================================================
    
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    
    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    }
    
    function setStatus(status, text) {
      statusEl.textContent = text;
      statusEl.className = `status ${status}`;
    }
    
    // ================================================
    // Strudel Import & State
    // ================================================
    
    let strudelReady = false;
    let isPlaying = false;
    
    // Control state - these will be read by patterns
    const state = {
      intensity: 0.5,
      leadEnabled: true,
      bassEnabled: false,
      hihatEnabled: false,
      kickEnabled: false
    };
    
    // ================================================
    // Initialize Strudel
    // ================================================
    
    document.getElementById('init').onclick = async () => {
      log('Initializing Strudel...');
      try {
        // Dynamic import to avoid SSR issues
        const { initStrudel } = await import('@strudel/web');
        await initStrudel();
        strudelReady = true;
        setStatus('ok', 'Ready');
        log('✓ Strudel initialized successfully!');
      } catch (err) {
        setStatus('error', 'Error');
        log(`✗ Error: ${err.message}`);
        console.error(err);
      }
    };
    
    // ================================================
    // Test 1: Basic Playback
    // ================================================
    
    document.getElementById('play').onclick = async () => {
      if (!strudelReady) {
        log('✗ Initialize Strudel first!');
        return;
      }
      
      log('Starting pattern...');
      try {
        const { note, s, stack, hush } = await import('@strudel/web');
        
        // Your track from strudel.cc - simplified for testing
        // Lead melody
        note("<0 4 0 9 7>*16")
          .scale("g:minor")
          .s("sawtooth")
          .lpf(200 + state.intensity * 1800)
          .gain(state.intensity * 0.5)
          .delay(0.6)
          .play();
        
        isPlaying = true;
        log('✓ Pattern started!');
        log(`  - LPF: ${200 + state.intensity * 1800}Hz`);
        log(`  - Gain: ${state.intensity * 0.5}`);
      } catch (err) {
        log(`✗ Error: ${err.message}`);
        console.error(err);
      }
    };
    
    document.getElementById('stop').onclick = async () => {
      if (!strudelReady) return;
      
      log('Stopping...');
      try {
        const { hush } = await import('@strudel/web');
        hush();
        isPlaying = false;
        log('✓ Stopped');
      } catch (err) {
        log(`✗ Error: ${err.message}`);
      }
    };
    
    // ================================================
    // Test 2: Dynamic Parameters
    // ================================================
    
    const intensitySlider = document.getElementById('intensity');
    const intensityValue = document.getElementById('intensityValue');
    
    intensitySlider.oninput = (e) => {
      state.intensity = e.target.value / 100;
      intensityValue.textContent = state.intensity.toFixed(2);
      log(`Intensity changed to ${state.intensity.toFixed(2)}`);
      
      // Note: This changes the state, but does the running pattern pick it up?
      // This is what we need to test!
    };
    
    // ================================================
    // Test 3: Layer Control
    // ================================================
    
    function setupLayerToggle(btnId, stateKey) {
      const btn = document.getElementById(btnId);
      btn.onclick = () => {
        state[stateKey] = !state[stateKey];
        const label = btnId.replace('toggle', '');
        btn.textContent = `${label}: ${state[stateKey] ? 'ON' : 'OFF'}`;
        btn.classList.toggle('active', state[stateKey]);
        log(`${label} ${state[stateKey] ? 'enabled' : 'disabled'}`);
      };
      // Set initial state
      btn.classList.toggle('active', state[stateKey]);
    }
    
    setupLayerToggle('toggleLead', 'leadEnabled');
    setupLayerToggle('toggleBass', 'bassEnabled');
    setupLayerToggle('toggleHihat', 'hihatEnabled');
    setupLayerToggle('toggleKick', 'kickEnabled');
    
    // ================================================
    // Test 4: One-Shot SFX
    // ================================================
    
    document.getElementById('triggerSfx').onclick = async () => {
      if (!strudelReady) {
        log('✗ Initialize Strudel first!');
        return;
      }
      
      log('Triggering one-shot SFX...');
      try {
        const { note } = await import('@strudel/web');
        
        // Attempt a one-shot note
        note("g4")
          .s("triangle")
          .decay(0.3)
          .sustain(0)
          .gain(0.5)
          .play();
        
        log('✓ SFX triggered');
      } catch (err) {
        log(`✗ Error: ${err.message}`);
        console.error(err);
      }
    };
    
    log('Page loaded. Click "Initialize Strudel" to begin.');
  </script>
</body>
</html>
